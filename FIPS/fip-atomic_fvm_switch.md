---
fip: <to be assigned>
title: Atomic switch to non-programmable FVM
authors: Ra√∫l Kripalani (@raulk), Steven Allen (@stebalien)
discussions-to: 
status: Draft
type: Technical Core
category: Core
created: 2022-02-03
spec-sections: 
  - TBD
requires:
  - 
replaces: N/A
---

# Atomic switch to non-programmable FVM

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [Simple Summary](#simple-summary)
- [Abstract](#abstract)
- [Change Motivation](#change-motivation)
- [Specification](#specification)
  - [WASM bytecode management](#wasm-bytecode-management)
  - [Warming up the module cache](#warming-up-the-module-cache)
  - [Atomic switch of execution layer](#atomic-switch-of-execution-layer)
  - [Migration procedure](#migration-procedure)
  - [Optional removal of intrinsic VM from Filecoin client codebases](#optional-removal-of-intrinsic-vm-from-filecoin-client-codebases)
- [Design Rationale](#design-rationale)
- [Backwards Compatibility](#backwards-compatibility)
- [Test Cases](#test-cases)
- [Security Considerations](#security-considerations)
- [Incentive Considerations](#incentive-considerations)
- [Product Considerations](#product-considerations)
- [Implementation](#implementation)
- [Copyright](#copyright)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Simple Summary

This FIP motions for an **atomic switch** from the current intrinsic VM to a
**non-programmable version of the Filecoin Virtual Machine**, at a chain epoch
TBD.

A baseline specification of the Filecoin Virtual Machine is provided in
[filecoin-project/FIPs#288](https://github.com/filecoin-project/FIPs/pull/288).
Only the canonical built-in actors will be supported after the atomic switch.

This switch won't introduce new user-facing features or capabilities, but it's
an important step in the trajectory towards full on-chain user-programmability.

## Abstract

At chain height TBD, the network's execution layer will transition from the
intrinsic VM to a non-programmable version of the FVM. By _non-programmable_ we
mean that users won't be able to deploy custom code, yet.

The network will continue running the logic of the prevailing built-in actor
version, estimated to be v7 (assuming this FIP is scheduled to go live right
after nv15: OhSnap).

However, the code and deployment form of built-in actors will now be Wasm
bytecode. Actor code will begin to be identified through real
content-addressing. The current _synthetic_ actor CodeCIDs will migrate to CIDs
that hash over their actual Wasm bytecode.

## Change Motivation

Swapping out core components in the execution layer of a blockchain is a complex
operation. It's analogous to replacing the engine of an airplane while airborne.

For this reason, its advisable to manage risk carefully. Monolithic, big-bang
deployments are risky. It's appropriate to break up changes in smaller units
that can be deployed in an orderly, incremental fashion, eventually leading up
to the final goal: on-chain user-programmability.

Even though this FIP doesn't introduce user-facing features, it represents a
fundamental technological transition in the network, where a new technology
comes alive and the previous technology is decomissioned, all in a single atomic
step.

Subsequent FVM-related FIPs will introduce changes atop the foundations
installed in the network by this FIP.

## Specification

### WASM bytecode management

The WASM bytecode for built-in actors will be available within CAR files
generated by the build scripts at repo:
https://github.com/filecoin-project/canonical-actors (TBD).

These CAR files will contain one block per built-in actor. The block will
contain the bytecode in raw and full (no chunking into IPLD DAGs).

The node must load the content of these CAR files into the node's state
blockstore. These blocks will remain orphan until the migration is run at the
upgrade epoch. Thus, any form of stage garbage collection must explicitly
protect these blocks from deletion (e.g. splitstore).

The node must verify that exactly N blocks were loaded, with CIDs ...

### Warming up the module cache

Prior to the upgrade epoch, it is advisable for the Filecoin client to warm up
the Wasm module cache by pre-compiling the built-in actors into machine code.

### Atomic switch of execution layer

Filecoin clients must simultaneously support both execution layers:

1. The current, intrinsic VM (the source).
2. The non-programmable FVM (the target).

At upgrade epoch TBD, blocks assembled by block producers in epoch TBD-1 with
the source VM will be compiled into a tipset and be executed by all validators
**with the target VM**.

From that moment onwards, block producers will construct blocks using the target
VM. Validators will validate tipsets with target VM also. In other words, both
block production and validation will operate with the target VM.

Following one finality (900 epochs), the deprecation of the source VM will be
considered final.

> Notes:
> Should we run sanity check procedures in the epochs preceding TBD? Validating
> tipsets in parallel with both VMs; and aborting the upgrade on mismatch.

### Migration procedure

At epoch TBD, prior to executing the tipset assembled at epoch TBD-1, Filecoin
clients will run a migration over the state tree to replace the CodeCID in the
ActorState struct of every actor.

The replacement will be performed according to this replacement table:

| Old value                         | New value                                             |
| --------------------------------- | ----------------------------------------------------- |
| `fil/7/system`                    |                                                       |
| `fil/7/init`                      |                                                       | 
| `fil/7/cron`                      |                                                       |
| `fil/7/account`                   |                                                       |
| `fil/7/storagepower`              |                                                       |
| `fil/7/storageminer`              |                                                       |
| `fil/7/storagemarket`             |                                                       |
| `fil/7/paymentchannel`            |                                                       |
| `fil/7/multisig`                  |                                                       |
| `fil/7/reward`                    |                                                       |
| `fil/7/verifiedregistry`          |                                                       |

> Notes:
> What would a premigration look like here?

### Optional removal of intrinsic VM from Filecoin client codebases

After the upgrade epoch is over and one finality is attained, Filecoin clients
may choose to complete erase the current VM from their respective codebases.

Because the canonical actors codebase supports only actors v6+, in doing so they
will lose the ability to sync past portions of the chain. This may be an
undesirable loss of functionality depending on the desired UX of every client,
hence why this is entirely optional.

Alternatively, Filecoin clients may provide historical chain support by
preserving the intrinsic VM in their codebases but activating it only through
optional compilation (e.g. using Go build flags, or Rust Cargo features).

## Design Rationale

WIP.

## Backwards Compatibility

WIP.

## Test Cases

WIP.

## Security Considerations

WIP.

## Incentive Considerations

N/A.

## Product Considerations

WIP.

## Implementation

WIP.

## Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
